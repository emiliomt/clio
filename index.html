<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clio - Personal Knowledge Base</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #212529;
            height: 100vh;
            overflow: hidden;
        }

        body.light-theme {
            background: #f8f9fa;
            color: #212529;
        }

        body.dark-theme {
            background: #1a1a1a;
            color: #e9ecef;
        }

        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .dark-theme .auth-card {
            background: #2d3748;
            color: #e9ecef;
        }

        .auth-card h1 {
            margin-bottom: 2rem;
            color: #333;
            font-size: 2rem;
            font-weight: 600;
        }

        .dark-theme .auth-card h1 {
            color: #e9ecef;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .dark-theme .form-group label {
            color: #cbd5e0;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .dark-theme .form-group input {
            background: #4a5568;
            border-color: #4a5568;
            color: #e9ecef;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 0.75rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 1rem;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .main-container {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dark-theme .header {
            background: #2d3748;
            border-bottom-color: #4a5568;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .app-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
        }

        .dark-theme .app-title {
            color: #e9ecef;
        }

        .lock-icon {
            width: 16px;
            height: 16px;
            fill: #667eea;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-btn {
            padding: 0.5rem 1rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .header-btn:hover {
            background: #5a6fd8;
        }

        .header-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .dark-theme .header-btn.secondary {
            background: #4a5568;
            color: #e9ecef;
        }

        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .dark-theme .sidebar {
            background: #2d3748;
            border-right-color: #4a5568;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .dark-theme .sidebar-header {
            border-bottom-color: #4a5568;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .dark-theme .search-input {
            background: #4a5568;
            border-color: #4a5568;
            color: #e9ecef;
        }

        .new-note-btn {
            width: 100%;
            padding: 0.5rem 1rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .new-note-btn:hover {
            background: #5a6fd8;
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .note-item {
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 0.25rem;
            transition: background 0.2s;
            border: 1px solid transparent;
        }

        .note-item:hover {
            background: #f8f9fa;
        }

        .dark-theme .note-item:hover {
            background: #4a5568;
        }

        .note-item.active {
            background: #e6f3ff;
            border-color: #667eea;
        }

        .dark-theme .note-item.active {
            background: #4a5568;
            border-color: #667eea;
        }

        .note-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .note-preview {
            font-size: 0.875rem;
            color: #6b7280;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dark-theme .note-preview {
            color: #a0aec0;
        }

        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .dark-theme .main-panel {
            background: #1a1a1a;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }

        .title-input {
            width: 100%;
            border: none;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            background: transparent;
            color: inherit;
        }

        .title-input:focus {
            outline: none;
        }

        .content-textarea {
            flex: 1;
            width: 100%;
            border: none;
            resize: none;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            background: transparent;
            color: inherit;
        }

        .content-textarea:focus {
            outline: none;
        }

        .editor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .dark-theme .editor-footer {
            border-top-color: #4a5568;
        }

        .delete-btn {
            padding: 0.5rem 1rem;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .backlinks-section {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background: #f8f9fa;
        }

        .dark-theme .backlinks-section {
            border-top-color: #4a5568;
            background: #2d3748;
        }

        .backlinks-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }

        .dark-theme .backlinks-title {
            color: #a0aec0;
        }

        .backlink-item {
            padding: 0.25rem 0;
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
        }

        .backlink-item:hover {
            color: #5a6fd8;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280;
        }

        .dark-theme .empty-state {
            color: #a0aec0;
        }

        .empty-state h2 {
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
        }

        .wiki-link {
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
        }

        .wiki-link:hover {
            color: #5a6fd8;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .success-message {
            color: #28a745;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .hidden {
            display: none !important;
        }

        .file-input {
            display: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .header-btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="light-theme">
    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <h1>Clio</h1>
            <form id="authForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn" id="authSubmit">Login</button>
                <button type="button" class="btn btn-secondary" id="toggleAuth">Register</button>
                <div id="authError" class="error-message hidden"></div>
            </form>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" class="main-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <span class="app-title">Clio</span>
                <svg class="lock-icon" viewBox="0 0 16 16">
                    <path d="M8 1a3 3 0 0 1 3 3v2h1a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h1V4a3 3 0 0 1 3-3zM6 6h4V4a2 2 0 1 0-4 0v2z"/>
                </svg>
            </div>
            <div class="header-right">
                <button id="exportBtn" class="header-btn">Export</button>
                <button id="importBtn" class="header-btn">Import</button>
                <input type="file" id="importFile" class="file-input" accept=".json">
                <button id="themeToggle" class="header-btn secondary">ðŸŒ™</button>
                <button id="logoutBtn" class="header-btn">Logout</button>
            </div>
        </header>

        <!-- Content -->
        <div class="content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search notes...">
                    <button id="newNoteBtn" class="new-note-btn">New Note</button>
                </div>
                <div id="notesList" class="notes-list">
                    <div class="empty-state">
                        <h2>No notes yet</h2>
                        <p>Create your first note to get started</p>
                    </div>
                </div>
            </aside>

            <!-- Main Panel -->
            <main class="main-panel">
                <div id="editorContainer" class="editor-container">
                    <div id="emptyEditor" class="empty-state">
                        <h2>Welcome to Clio</h2>
                        <p>Select a note to start editing or create a new one</p>
                    </div>
                    
                    <div id="noteEditor" class="hidden">
                        <input type="text" id="titleInput" class="title-input" placeholder="Note title...">
                        <textarea id="contentTextarea" class="content-textarea" placeholder="Start writing..."></textarea>
                    </div>
                </div>
                
                <div id="editorFooter" class="editor-footer hidden">
                    <button id="deleteNoteBtn" class="delete-btn">Delete Note</button>
                    <div id="autoSaveStatus"></div>
                </div>

                <div id="backlinksSection" class="backlinks-section hidden">
                    <div class="backlinks-title">Linked from:</div>
                    <div id="backlinksList"></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let notes = [];
        let currentNoteId = null;
        let isLoginMode = true;
        let autoSaveTimeout = null;

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const mainContainer = document.getElementById('mainContainer');
        const authForm = document.getElementById('authForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authSubmit = document.getElementById('authSubmit');
        const toggleAuth = document.getElementById('toggleAuth');
        const authError = document.getElementById('authError');
        const searchInput = document.getElementById('searchInput');
        const newNoteBtn = document.getElementById('newNoteBtn');
        const notesList = document.getElementById('notesList');
        const emptyEditor = document.getElementById('emptyEditor');
        const noteEditor = document.getElementById('noteEditor');
        const titleInput = document.getElementById('titleInput');
        const contentTextarea = document.getElementById('contentTextarea');
        const editorFooter = document.getElementById('editorFooter');
        const deleteNoteBtn = document.getElementById('deleteNoteBtn');
        const backlinksSection = document.getElementById('backlinksSection');
        const backlinksList = document.getElementById('backlinksList');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const themeToggle = document.getElementById('themeToggle');
        const logoutBtn = document.getElementById('logoutBtn');
        const autoSaveStatus = document.getElementById('autoSaveStatus');

        // Initialize the application
        function init() {
            loadTheme();
            loadUser();
            setupEventListeners();
        }

        function setupEventListeners() {
            authForm.addEventListener('submit', handleAuth);
            toggleAuth.addEventListener('click', toggleAuthMode);
            newNoteBtn.addEventListener('click', createNewNote);
            searchInput.addEventListener('input', handleSearch);
            titleInput.addEventListener('input', handleTitleChange);
            contentTextarea.addEventListener('input', handleContentChange);
            deleteNoteBtn.addEventListener('click', handleDeleteNote);
            exportBtn.addEventListener('click', exportNotes);
            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', importNotes);
            themeToggle.addEventListener('click', toggleTheme);
            logoutBtn.addEventListener('click', logout);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    showAutoSaveMessage('Note saved');
                }
            });

            // Wiki link handling
            contentTextarea.addEventListener('click', handleWikiLinkClick);
        }

        function loadTheme() {
            const theme = localStorage.getItem('clio-theme') || 'light';
            document.body.className = `${theme}-theme`;
            themeToggle.textContent = theme === 'light' ? 'ðŸŒ™' : 'â˜€ï¸';
        }

        function toggleTheme() {
            const isLight = document.body.classList.contains('light-theme');
            const newTheme = isLight ? 'dark' : 'light';
            document.body.className = `${newTheme}-theme`;
            themeToggle.textContent = isLight ? 'â˜€ï¸' : 'ðŸŒ™';
            localStorage.setItem('clio-theme', newTheme);
        }

        function loadUser() {
            const user = localStorage.getItem('clio-user');
            if (user) {
                currentUser = JSON.parse(user);
                loadNotes();
                showMainApp();
            }
        }

        function saveUser() {
            localStorage.setItem('clio-user', JSON.stringify(currentUser));
        }

        function loadNotes() {
            const savedNotes = localStorage.getItem(`clio-notes-${currentUser.id}`);
            notes = savedNotes ? JSON.parse(savedNotes) : [];
            renderNotesList();
        }

        function saveNotes() {
            localStorage.setItem(`clio-notes-${currentUser.id}`, JSON.stringify(notes));
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            authSubmit.textContent = isLoginMode ? 'Login' : 'Register';
            toggleAuth.textContent = isLoginMode ? 'Register' : 'Login';
            hideError();
        }

        function handleAuth(e) {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;

            if (isLoginMode) {
                login(email, password);
            } else {
                register(email, password);
            }
        }

        function register(email, password) {
            const users = JSON.parse(localStorage.getItem('clio-users') || '[]');
            
            if (users.find(u => u.email === email)) {
                showError('User already exists');
                return;
            }

            const newUser = {
                id: Date.now().toString(),
                email: email,
                password: hashPassword(password) // In real app, use bcrypt
            };

            users.push(newUser);
            localStorage.setItem('clio-users', JSON.stringify(users));
            
            currentUser = { id: newUser.id, email: newUser.email };
            saveUser();
            loadNotes();
            showMainApp();
        }

        function login(email, password) {
            const users = JSON.parse(localStorage.getItem('clio-users') || '[]');
            const user = users.find(u => u.email === email && u.password === hashPassword(password));

            if (!user) {
                showError('Invalid email or password');
                return;
            }

            currentUser = { id: user.id, email: user.email };
            saveUser();
            loadNotes();
            showMainApp();
        }

        function hashPassword(password) {
            // Simple hash for demo - use bcrypt in real app
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        function logout() {
            currentUser = null;
            notes = [];
            currentNoteId = null;
            localStorage.removeItem('clio-user');
            showAuthApp();
        }

        function showAuthApp() {
            authContainer.style.display = 'flex';
            mainContainer.style.display = 'none';
            emailInput.value = '';
            passwordInput.value = '';
            hideError();
        }

        function showMainApp() {
            authContainer.style.display = 'none';
            mainContainer.style.display = 'flex';
            renderNotesList();
        }

        function showError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
        }

        function hideError() {
            authError.classList.add('hidden');
        }

        function createNewNote() {
            const newNote = {
                id: Date.now().toString(),
                title: 'Untitled',
                content: '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            notes.unshift(newNote);
            saveNotes();
            renderNotesList();
            selectNote(newNote.id);
            titleInput.focus();
            titleInput.select();
        }

        function selectNote(noteId) {
            currentNoteId = noteId;
            const note = notes.find(n => n.id === noteId);
            
            if (note) {
                titleInput.value = note.title;
                contentTextarea.value = note.content;
                
                emptyEditor.classList.add('hidden');
                noteEditor.classList.remove('hidden');
                editorFooter.classList.remove('hidden');
                
                renderWikiLinks();
                renderBacklinks();
                updateActiveNote();
            }
        }

        function updateActiveNote() {
            document.querySelectorAll('.note-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`[data-note-id="${currentNoteId}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        function handleTitleChange() {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.title = titleInput.value || 'Untitled';
                note.updatedAt = new Date().toISOString();
                debouncedSave();
            }
        }

        function handleContentChange() {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (note) {
                note.content = contentTextarea.value;
                note.updatedAt = new Date().toISOString();
                debouncedSave();
                renderWikiLinks();
                renderBacklinks();
            }
        }

        function debouncedSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveNotes();
                renderNotesList();
                showAutoSaveMessage('Auto-saved');
            }, 300);
        }

        function showAutoSaveMessage(message) {
            autoSaveStatus.textContent = message;
            autoSaveStatus.style.color = '#28a745';
            setTimeout(() => {
                autoSaveStatus.textContent = '';
            }, 2000);
        }

        function handleDeleteNote() {
            if (!currentNoteId) return;
            
            if (confirm('Are you sure you want to delete this note?')) {
                notes = notes.filter(n => n.id !== currentNoteId);
                saveNotes();
                renderNotesList();
                
                currentNoteId = null;
                emptyEditor.classList.remove('hidden');
                noteEditor.classList.add('hidden');
                editorFooter.classList.add('hidden');
                backlinksSection.classList.add('hidden');
            }
        }

        function renderNotesList(filteredNotes = null) {
            const notesToRender = filteredNotes || notes;
            
            if (notesToRender.length === 0) {
                notesList.innerHTML = `
                    <div class="empty-state">
                        <h2>${filteredNotes ? 'No notes found' : 'No notes yet'}</h2>
                        <p>${filteredNotes ? 'Try a different search term' : 'Create your first note to get started'}</p>
                    </div>
                `;
                return;
            }

            const sortedNotes = [...notesToRender].sort((a, b) => 
                new Date(b.updatedAt) - new Date(a.updatedAt)
            );

            notesList.innerHTML = sortedNotes.map(note => `
                <div class="note-item" data-note-id="${note.id}">
                    <div class="note-title">${escapeHtml(note.title)}</div>
                    <div class="note-preview">${escapeHtml(note.content.substring(0, 100))}</div>
                </div>
            `).join('');

            // Add click listeners
            document.querySelectorAll('.note-item').forEach(item => {
                item.addEventListener('click', () => {
                    selectNote(item.dataset.noteId);
                });
            });

            updateActiveNote();
        }

        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            
            if (!searchTerm) {
                renderNotesList();
                return;
            }

            const filteredNotes = notes.filter(note => 
                note.title.toLowerCase().includes(searchTerm) ||
                note.content.toLowerCase().includes(searchTerm)
            );

            renderNotesList(filteredNotes);
        }

        function renderWikiLinks() {
            const content = contentTextarea.value;
            const wikiLinkRegex = /\[\[([^\]]+)\]\]/g;
            
            // This is a simplified version - in a real app you'd want to render the links visually
            // For now, we'll just make them clickable in the textarea
        }

        function handleWikiLinkClick(e) {
            const textarea = e.target;
            const cursorPos = textarea.selectionStart;
            const content = textarea.value;
            
            // Find if cursor is inside a wiki link
            const beforeCursor = content.substring(0, cursorPos);
            const afterCursor = content.substring(cursorPos);
            
            const startMatch = beforeCursor.match(/\[\[([^\]]*?)$/);
            const endMatch = afterCursor.match(/^([^\]]*?)\]\]/);
            
            if (startMatch && endMatch) {
                const linkTitle = startMatch[1] + endMatch[1];
                navigateToWikiLink(linkTitle);
            }
        }

        function navigateToWikiLink(title) {
            let targetNote = notes.find(n => n.title.toLowerCase() === title.toLowerCase());
            
            if (!targetNote) {
                // Create new note
                targetNote = {
                    id: Date.now().toString(),
                    title: title,
                    content: '',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                notes.unshift(targetNote);
                saveNotes();
                renderNotesList();
            }
            
            selectNote(targetNote.id);
        }

        function renderBacklinks() {
            if (!currentNoteId) {
                backlinksSection.classList.add('hidden');
                return;
            }

            const currentNote = notes.find(n => n.id === currentNoteId);
            if (!currentNote) return;

            const backlinks = notes.filter(note => {
                if (note.id === currentNoteId) return false;
                const wikiLinkRegex = new RegExp(`\\[\\[${escapeRegExp(currentNote.title)}\\]\\]`, 'gi');
                return wikiLinkRegex.test(note.content);
            });

            if (backlinks.length === 0) {
                backlinksSection.classList.add('hidden');
                return;
            }

            backlinksSection.classList.remove('hidden');
            backlinksList.innerHTML = backlinks.map(note => `
                <div class="backlink-item" data-note-id="${note.id}">
                    ${escapeHtml(note.title)}
                </div>
            `).join('');

            // Add click listeners to backlinks
            document.querySelectorAll('.backlink-item').forEach(item => {
                item.addEventListener('click', () => {
                    selectNote(item.dataset.noteId);
                });
            });
        }

        function exportNotes() {
            const exportData = {
                notes: notes,
                exportedAt: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `clio-notes-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importNotes(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importData.notes)) {
                        throw new Error('Invalid file format');
                    }

                    const action = confirm('Import mode:\nOK = Replace all notes\nCancel = Merge with existing notes');
                    
                    if (action) {
                        // Replace all notes
                        notes = importData.notes;
                    } else {
                        // Merge notes
                        const existingIds = new Set(notes.map(n => n.id));
                        const newNotes = importData.notes.filter(n => !existingIds.has(n.id));
                        notes = [...notes, ...newNotes];
                    }

                    saveNotes();
                    renderNotesList();
                    showAutoSaveMessage('Import successful');
                } catch (error) {
                    alert('Error importing file: Invalid format');
                }
            };
            
            reader.readAsText(file);
            e.target.value = '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Initialize the app
        init();
    </script>
</body>
</html>